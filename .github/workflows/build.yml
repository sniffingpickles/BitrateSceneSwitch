name: Build OBS Plugin

on:
  push:
    branches: [main, master]
    tags: ['*']
  pull_request:
    branches: [main, master]

env:
  PLUGIN_NAME: BitrateSceneSwitch

jobs:
  build-windows:
    name: Build for Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.1'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qtwebsockets'

      - name: Download OBS Studio
        run: |
          $obsVersion = "31.0.0"
          $obsUrl = "https://github.com/obsproject/obs-studio/releases/download/$obsVersion/OBS-Studio-$obsVersion-Windows.zip"
          Invoke-WebRequest -Uri $obsUrl -OutFile obs-studio.zip
          Expand-Archive obs-studio.zip -DestinationPath obs-studio-install

      - name: Download OBS Libraries
        run: |
          $obsVersion = "31.0.0"
          $libsUrl = "https://github.com/obsproject/obs-studio/releases/download/$obsVersion/OBS-Studio-$obsVersion-Windows-PDBs.zip"
          Invoke-WebRequest -Uri $libsUrl -OutFile obs-libs.zip -ErrorAction SilentlyContinue
          
      - name: Clone OBS Studio Source
        run: |
          git clone --depth 1 --branch 31.0.0 https://github.com/obsproject/obs-studio.git obs-src

      - name: Install CURL
        run: |
          vcpkg install curl:x64-windows

      - name: Configure CMake
        run: |
          cmake -B build -S . `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}" `
            -DQt6_DIR="${{ env.Qt6_DIR }}/lib/cmake/Qt6" `
            -Dlibobs_DIR="obs-src/libobs" `
            -Dobs-frontend-api_DIR="obs-src/UI/obs-frontend-api" `
            -DCURL_ROOT="C:/vcpkg/installed/x64-windows"

      - name: Build
        run: cmake --build build --config Release

      - name: Package
        run: |
          mkdir -p package/obs-plugins/64bit
          mkdir -p package/data/obs-plugins/${{ env.PLUGIN_NAME }}
          cp build/Release/${{ env.PLUGIN_NAME }}.dll package/obs-plugins/64bit/
          cp -r data/* package/data/obs-plugins/${{ env.PLUGIN_NAME }}/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-windows
          path: package/

  build-windows-simple:
    name: Build Windows (Simple)
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Dependencies
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
          
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.1'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'

      - name: Download OBS Dependencies
        shell: pwsh
        run: |
          # Download pre-built OBS deps
          $depsUrl = "https://github.com/obsproject/obs-deps/releases/download/2024-08-01/windows-deps-2024-08-01-x64.zip"
          Invoke-WebRequest -Uri $depsUrl -OutFile deps.zip
          Expand-Archive deps.zip -DestinationPath deps
          
          # Download OBS Studio source for headers
          git clone --depth 1 --branch 31.0.0 https://github.com/obsproject/obs-studio.git obs-studio
          
      - name: Build OBS Libraries
        shell: pwsh
        run: |
          cd obs-studio
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DENABLE_BROWSER=OFF -DENABLE_SCRIPTING=OFF -DENABLE_UI=OFF
          cmake --build build --config Release --target libobs obs-frontend-api
          cd ..

      - name: Configure Plugin
        shell: pwsh
        run: |
          cmake -B build -S . `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }};deps" `
            -Dlibobs_DIR="obs-studio/build/libobs" `
            -Dobs-frontend-api_DIR="obs-studio/build/UI/obs-frontend-api"

      - name: Build Plugin
        run: cmake --build build --config Release

      - name: Package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "release/obs-plugins/64bit"
          New-Item -ItemType Directory -Force -Path "release/data/obs-plugins/${{ env.PLUGIN_NAME }}"
          Copy-Item "build/Release/${{ env.PLUGIN_NAME }}.dll" "release/obs-plugins/64bit/"
          Copy-Item -Recurse "data/*" "release/data/obs-plugins/${{ env.PLUGIN_NAME }}/"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-windows-x64
          path: release/

  release:
    name: Create Release
    needs: [build-windows-simple]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release Archive
        run: |
          cd artifacts/${{ env.PLUGIN_NAME }}-windows-x64
          zip -r ../../${{ env.PLUGIN_NAME }}-${{ github.ref_name }}-windows-x64.zip .

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.PLUGIN_NAME }}-${{ github.ref_name }}-windows-x64.zip
          draft: false
          prerelease: false
