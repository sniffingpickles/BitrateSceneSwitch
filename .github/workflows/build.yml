name: Build OBS Plugin

on:
  push:
    branches: [main, master]
    tags: ['*']
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  PLUGIN_NAME: BitrateSceneSwitch
  OBS_VERSION: "31.0.0"

jobs:
  build-windows:
    name: Build for Windows x64
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.7.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          cache: true

      - name: Cache OBS Studio source
        id: cache-obs
        uses: actions/cache@v4
        with:
          path: obs-studio
          key: obs-studio-${{ env.OBS_VERSION }}

      - name: Clone OBS Studio
        if: steps.cache-obs.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          git clone --depth 1 --branch ${{ env.OBS_VERSION }} https://github.com/obsproject/obs-studio.git obs-studio
          cd obs-studio
          git submodule update --init --recursive --depth 1
          cd ..

      - name: Cache OBS deps
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: obs-deps
          key: obs-deps-2025-08-23-x64

      - name: Download OBS deps
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $depsUrl = "https://github.com/obsproject/obs-deps/releases/download/2025-08-23/windows-deps-2025-08-23-x64.zip"
          Invoke-WebRequest -Uri $depsUrl -OutFile deps.zip
          Expand-Archive deps.zip -DestinationPath obs-deps

      - name: Cache CURL
        id: cache-curl
        uses: actions/cache@v4
        with:
          path: curl
          key: curl-8.6.0-win64

      - name: Download pre-built CURL
        if: steps.cache-curl.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $curlUrl = "https://curl.se/windows/dl-8.6.0_1/curl-8.6.0_1-win64-mingw.zip"
          Invoke-WebRequest -Uri $curlUrl -OutFile curl.zip
          Expand-Archive curl.zip -DestinationPath curl-download
          Move-Item curl-download/curl-* curl

      - name: Cache OBS build
        id: cache-obs-build
        uses: actions/cache@v4
        with:
          path: obs-studio/build
          key: obs-build-${{ env.OBS_VERSION }}-msvc-release

      - name: Build OBS Libraries
        if: steps.cache-obs-build.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          cd obs-studio
          cmake -B build -S . -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DENABLE_BROWSER=OFF `
            -DENABLE_SCRIPTING=OFF `
            -DENABLE_UI=ON `
            -DENABLE_PLUGINS=OFF `
            -DENABLE_VIRTUALCAM=OFF `
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}/obs-deps"
          cmake --build build --config Release --target libobs obs-frontend-api -- /m
          cd ..

      - name: Configure Plugin
        shell: pwsh
        run: |
          $obsDir = "${{ github.workspace }}/obs-studio"
          $curlDir = "${{ github.workspace }}/curl"
          $obsBuildDir = "$obsDir/build"
          cmake -B build -S . -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }};${{ github.workspace }}/obs-deps;$obsBuildDir" `
            -Dlibobs_DIR="$obsBuildDir/libobs" `
            -Dobs-frontend-api_DIR="$obsBuildDir/UI/obs-frontend-api" `
            -Dw32-pthreads_DIR="$obsBuildDir/deps/w32-pthreads" `
            -DCURL_INCLUDE_DIR="$curlDir/include" `
            -DCURL_LIBRARY="$curlDir/lib/libcurl.dll.a"

      - name: Build Plugin
        run: cmake --build build --config Release

      - name: Package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "release/obs-plugins/64bit"
          New-Item -ItemType Directory -Force -Path "release/data/obs-plugins/${{ env.PLUGIN_NAME }}"
          
          # Copy plugin DLL
          $dllPath = "build/Release/${{ env.PLUGIN_NAME }}.dll"
          if (Test-Path $dllPath) {
            Copy-Item $dllPath "release/obs-plugins/64bit/"
          } else {
            Write-Host "DLL not found at $dllPath, searching..."
            Get-ChildItem -Path build -Recurse -Filter "*.dll" | ForEach-Object { Write-Host $_.FullName }
          }
          
          # Copy curl DLL
          Copy-Item "curl/bin/libcurl-x64.dll" "release/obs-plugins/64bit/"
          
          # Copy data files
          if (Test-Path "data") {
            Copy-Item -Recurse "data/*" "release/data/obs-plugins/${{ env.PLUGIN_NAME }}/"
          }

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-windows-x64
          path: release/

  release:
    name: Create Release
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release Archive
        run: |
          cd artifacts/${{ env.PLUGIN_NAME }}-windows-x64
          zip -r ../../${{ env.PLUGIN_NAME }}-${{ github.ref_name }}-windows-x64.zip .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.PLUGIN_NAME }}-${{ github.ref_name }}-windows-x64.zip
          draft: false
          prerelease: false
